import{OAuthInit as t,OAuthAuthenticate as e,OAuthLink as i,OAuthUnlink as r}from"@privy-io/public-api";import{PrivyClientError as s}from"../../Error.mjs";import{createCodeVerifier as a,createStateCode as o,deriveCodeChallengeFromCodeVerifier as n,CODE_VERIFIER_KEY as h,STATE_CODE_KEY as l}from"../../pkce.mjs";import"jose";class p{async generateURL(e,i){let r=a(),s=o(),p=await n({codeVerifier:r,digest:this._crypto?.digest});return await Promise.all([this._storage.put(h,r),this._storage.put(l,s)]),this._privyInternal.fetch(t,{body:{redirect_to:i,provider:e,code_challenge:p,state_code:s}})}async loginWithCode(t,i,r,a,o){let[n,p]=await Promise.all([this._storage.get(h),this._storage.get(l)]);if(p!==i)throw this._privyInternal.createAnalyticsEvent("possible_phishing_attempt",{flow:"oauth",provider:r,storedStateCode:p??"",returnedStateCode:i??""}),new s({code:"pkce_state_code_mismatch",error:"Unexpected auth flow. This may be a phishing attempt."});let _=await this._privyInternal.fetch(e,{body:{authorization_code:t,code_type:a,state_code:p,code_verifier:n,mode:o}});return await this._privyInternal.session.updateWithTokensResponse(_),this._privyInternal.callbacks?.setUser?.(_.user),await Promise.all([this._storage.del(h),this._storage.del(l)]),_}async linkWithCode(t,e,r,a){let[o,n]=await Promise.all([this._storage.get(h),this._storage.get(l)]);if(n!==e)throw this._privyInternal.createAnalyticsEvent("possible_phishing_attempt",{flow:"oauth",provider:r,storedStateCode:n??"",returnedStateCode:e??""}),new s({code:"pkce_state_code_mismatch",error:"Unexpected auth flow. This may be a phishing attempt."});let p=await this._privyInternal.fetch(i,{body:{authorization_code:t,code_type:a,state_code:n,code_verifier:o}});await this._privyInternal.session.processOAuthTokens(p.oauth_tokens);let _=await this._privyInternal.refreshSession();return await Promise.all([this._storage.del(h),this._storage.del(l)]),_.user}async unlink(t,e){return await this._privyInternal.fetch(r,{body:{provider:t,subject:e}}),(await this._privyInternal.refreshSession()).user}constructor(t,e,i){this._privyInternal=t,this._storage=e,this._crypto=i}}export{p as default};
