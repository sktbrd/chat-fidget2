import{RunEffectOnce as t}from"../effect.mjs";import{PrivyClientError as e,PrivyErrorCode as i,formatApiError as n}from"../errors.mjs";import{passkeyAuthenticatePath as s,passkeyLinkPath as a,passkeyInitAuthenticatePath as r,passkeyInitLinkPath as o}from"../paths.mjs";import{getUiHeader as c}from"./getUiHeader.mjs";import"ofetch";class h{async initAuthenticationFlow(t){if(!this.api)throw new e("Auth flow has no API instance");this.meta.initAuthenticateResponse=await this.initAuthenticateOnce.execute(t)}async initLinkFlow(){if(!this.api)throw new e("Auth flow has no API instance");this.meta.initLinkResponse=await this.initLinkOnce.execute()}async authenticate(){let t=await import("@simplewebauthn/browser");if(!this.api)throw new e("Auth flow has no API instance");if(!t.browserSupportsWebAuthn())throw new e("WebAuthn is not supported in this browser");this.meta.initAuthenticateResponse||(this.meta.initAuthenticateResponse=await this.initAuthenticateOnce.execute());try{let e=await t.startAuthentication(this._transformInitAuthenticateOptionsToCamelCase(this.meta.initAuthenticateResponse.options));return this.meta.setPasskeyAuthState?.({status:"submitting-response"}),await this.api.post(s,{relying_party:this.meta.initAuthenticateResponse.relying_party,challenge:this.meta.initAuthenticateResponse.options.challenge,authenticator_response:this._transformAuthenticationResponseToSnakeCase(e)})}catch(t){if("NotAllowedError"===t.name)throw new e("Passkey request timed out or rejected by user.",void 0,i.PASSKEY_NOT_ALLOWED);throw n(t)}}async link(){let t=await import("@simplewebauthn/browser");if(!this.api)throw new e("Auth flow has no API instance");if(!t.browserSupportsWebAuthn())throw new e("WebAuthn is not supported in this browser");this.meta.initLinkResponse||(this.meta.initLinkResponse=await this.initLinkOnce.execute());try{let e=this.meta.initLinkResponse.options,i=await t.startRegistration(this._transformInitLinkOptionsToCamelCase(e));return this.meta.setPasskeyAuthState?.({status:"submitting-response"}),await this.api.post(a,{relying_party:this.meta.initLinkResponse.relying_party,authenticator_response:this._transformRegistrationResponseToSnakeCase(i)})}catch(t){if("NotAllowedError"===t.name)throw new e("Passkey request timed out or rejected by user.",void 0,i.PASSKEY_NOT_ALLOWED);throw n(t)}}async _initAuthenticateOnce(t){if(!this.api)throw new e("Auth flow has no API instance");let i=c(t);return await this.api.post(r,{token:this.meta.captchaToken},{headers:{...i}})}async _initLinkOnce(){if(!this.api)throw new e("Auth flow has no API instance");return await this.api.post(o,{})}_transformInitLinkOptionsToCamelCase(t){return{rp:t.rp,user:{id:t.user.id,name:t.user.name,displayName:t.user.display_name},challenge:t.challenge,pubKeyCredParams:t.pub_key_cred_params.map((t=>({type:t.type,alg:t.alg}))),timeout:t.timeout,excludeCredentials:t.exclude_credentials?.map((t=>({id:t.id,type:t.type,transports:t.transports}))),authenticatorSelection:{authenticatorAttachment:t.authenticator_selection?.authenticator_attachment,requireResidentKey:t.authenticator_selection?.require_resident_key,residentKey:t.authenticator_selection?.resident_key,userVerification:t.authenticator_selection?.user_verification},attestation:t.attestation,extensions:{appid:t.extensions?.app_id,credProps:t.extensions?.cred_props?.rk,hmacCreateSecret:t.extensions?.hmac_create_secret}}}_transformRegistrationResponseToSnakeCase(t){return{id:t.id,raw_id:t.rawId,response:{client_data_json:t.response.clientDataJSON,attestation_object:t.response.attestationObject,authenticator_data:t.response.authenticatorData},authenticator_attachment:t.authenticatorAttachment,client_extension_results:{app_id:t.clientExtensionResults.appid,cred_props:t.clientExtensionResults.credProps,hmac_create_secret:t.clientExtensionResults.hmacCreateSecret},type:t.type}}_transformInitAuthenticateOptionsToCamelCase(t){return{rpId:t.rp_id,challenge:t.challenge,allowCredentials:t.allow_credentials?.map((t=>({id:t.id,type:t.type,transports:t.transports})))||[],timeout:t.timeout,extensions:{appid:t.extensions?.app_id,credProps:t.extensions?.cred_props,hmacCreateSecret:t.extensions?.hmac_create_secret},userVerification:t.user_verification}}_transformAuthenticationResponseToSnakeCase(t){return{id:t.id,raw_id:t.rawId,response:{client_data_json:t.response.clientDataJSON,authenticator_data:t.response.authenticatorData,signature:t.response.signature,user_handle:t.response.userHandle},authenticator_attachment:t.authenticatorAttachment,client_extension_results:{app_id:t.clientExtensionResults.appid,cred_props:t.clientExtensionResults.credProps,hmac_create_secret:t.clientExtensionResults.hmacCreateSecret},type:t.type}}constructor({captchaToken:e,setPasskeyAuthState:i}){this.initAuthenticateOnce=new t(this._initAuthenticateOnce.bind(this)),this.initLinkOnce=new t(this._initLinkOnce.bind(this)),this.meta={captchaToken:e,setPasskeyAuthState:i}}}export{h as PasskeyFlow};
