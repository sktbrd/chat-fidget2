"use strict";var e=require("react/jsx-runtime"),r=require("react"),n=require("react-device-detect"),t=require("styled-components"),o=require("../auth-flows/siwe.js"),i=require("../auth-flows/siws.js"),s=require("../client/user.js"),c=require("../components/Button.js"),a=require("../components/Layouts.js"),l=require("../components/Loader.js"),u=require("../components/ModalFooter.js"),d=require("../components/ModalHeader.js"),h=require("../connectors/errors.js"),j=require("../connectors/is-wallet-installed.js"),p=require("../connectors/userAlreadyHasConnectedCoinbaseWallet.js"),E=require("../connectors/walletconnect-v2.js"),C=require("../constants.js"),q=require("../errors.js"),y=require("../hook-utils/useInterval.js"),g=require("../hooks/captcha-context.js"),w=require("../hooks/internal-context.js"),S=require("../hooks/modal-context.js"),v=require("../hooks/privy-context.js"),_=require("../lib/external-wallets/displayHelpers.js"),m=require("../lib/useHasTabbedAway.js"),f=require("../svg/browser-extension-wallet-icon.js"),b=require("../utils/index.js"),T=require("./index.js");require("../effect.js"),require("../lib/siwe.js"),require("../lib/siws.js"),require("@ethersproject/address"),require("../svg/protected-by-privy.js"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("../configuration/context.js"),require("../config.js"),require("../configuration/defaultClientConfig.js"),require("../configuration/login-methods.js"),require("../configuration/wallets.js"),require("../connectors/chains/index.js"),require("../connectors/chains/arbitrum.js"),require("../connectors/chains/arbitrumSepolia.js"),require("../connectors/chains/avalanche.js"),require("../connectors/chains/avalancheFuji.js"),require("../connectors/chains/base.js"),require("../connectors/chains/baseSepolia.js"),require("../connectors/chains/berachainArtio.js"),require("../connectors/chains/celo.js"),require("../connectors/chains/celoAlfajores.js"),require("../connectors/chains/filecoin.js"),require("../connectors/chains/filecoinCalibration.js"),require("../connectors/chains/garnetHolesky.js"),require("../connectors/chains/holesky.js"),require("../connectors/chains/linea.js"),require("../connectors/chains/lineaTestnet.js"),require("../connectors/chains/lukso.js"),require("../connectors/chains/mainnet.js"),require("../connectors/chains/optimism.js"),require("../connectors/chains/optimismSepolia.js"),require("../connectors/chains/polygon.js"),require("../connectors/chains/polygonAmoy.js"),require("../connectors/chains/redstone.js"),require("../connectors/chains/sepolia.js"),require("../connectors/chains/zora.js"),require("../connectors/chains/zoraSepolia.js"),require("../connectors/chains/zoraTestnet.js"),require("../connectors/chains/utils.js"),require("../lib/solana/index.js"),require("../theme.js"),require("tinycolor2"),require("../lib/cybr53.js"),require("@ethersproject/logger"),require("@privy-io/js-sdk-core"),require("../connectors/get-legacy-injected-providers.js"),require("viem"),require("@walletconnect/ethereum-provider"),require("../svg/metamask.js"),require("../svg/wallet-connect.js"),require("../connectors/ethereum/index.js"),require("@ethersproject/providers"),require("../storage.js"),require("../connectors/areWalletArraysEqual.js"),require("../connectors/isBaseConnectedEthereumWallet.js"),require("../connectors/base.js"),require("eventemitter3"),require("../connectors/getRpcTimeout.js"),require("../connectors/privyProxyProvider.js"),require("../connectors/walletconnect-registry.js"),require("ofetch"),require("../hooks/index.js"),require("../components/PrefetchedImage.js"),require("../svg/brave-browser-icon.js"),require("../svg/bybit.js"),require("../svg/coinbase-wallet.js"),require("../svg/cryptocom.js"),require("../svg/phantom.js"),require("../svg/rabby.js"),require("../svg/rainbow.js"),require("../svg/safe.js"),require("../svg/uniswap.js"),require("../svg/universal-profile.js"),require("../svg/zerion.js");const R=e=>e?.privyErrorCode===q.PrivyErrorCode.LINKED_TO_ANOTHER_USER?h.ConnectorErrors.ERROR_USER_EXISTS:e instanceof h.PrivyProviderRpcError&&!e.details.default?e.details:e instanceof h.WalletTimeoutError?h.ConnectorErrors.ERROR_TIMED_OUT:e instanceof h.UserRejectedConnectionError?h.ConnectorErrors.ERROR_USER_REJECTED_CONNECTION:e?.privyErrorCode===q.PrivyErrorCode.CANNOT_LINK_MORE_OF_TYPE?h.ConnectorErrors.ERROR_USER_LIMIT_REACHED:h.ConnectorErrors.ERROR_WALLET_CONNECTION;let x=/*#__PURE__*/t.styled.div.withConfig({displayName:"ConnectContainer",componentId:"sc-afad057-0"})(["display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;width:100%;"]),A=/*#__PURE__*/t.styled.div.withConfig({displayName:"StackedContainer",componentId:"sc-afad057-1"})(["display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%;height:82px;> div{position:relative;}> div > span{position:absolute;left:-41px;top:-41px;}> div > :last-child{position:absolute;left:-19px;top:-19px;}"]);const N=r=>{let n=r.walletLogo;/*#__PURE__*/return e.jsx(e.Fragment,{children:/*#__PURE__*/e.jsx(A,{children:/*#__PURE__*/e.jsxs("div",{children:[/*#__PURE__*/e.jsx(l.ConnectionLoader,{success:r.success,fail:r.fail}),"string"==typeof n?
/*#__PURE__*/e.jsx("span",{style:{background:`url('${n}')`,height:"38px",width:"38px",borderRadius:"6px",margin:"auto",backgroundSize:"cover"}}):/*#__PURE__*/e.jsx(n,{style:{width:"38px",height:"38px"}})]})})})};exports.ConnectionStatusScreen=()=>{let t,[l,A]=r.useState(!1),[I,k]=r.useState(!1),[O,M]=r.useState(void 0),{authenticated:W,logout:L}=v.usePrivyContext(),{app:U,navigate:P,navigateBack:D,lastScreen:F,currentScreen:B,setModalData:H,data:z}=S.usePrivyModal(),{getAuthFlow:X,walletConnectionStatus:V,closePrivyModal:J,initLoginWithWallet:K,loginWithWallet:$,updateWallets:G,createAnalyticsEvent:Q}=w.usePrivyInternal(),{walletConnectors:Y}=v.usePrivyContext(),[Z,ee]=r.useState(0),{user:re}=v.usePrivyContext(),[ne]=r.useState(re?.linkedAccounts.length||0),[te,oe]=r.useState(""),[ie,se]=r.useState(""),[ce,ae]=r.useState(!1),{hasTabbedAway:le}=m.useHasTabbedAway(),{enabled:ue,token:de}=g.useCaptcha(),he=n.isMobile&&"wallet_connect_v2"===V?.connector?.connectorType||n.isMobile&&"coinbase_wallet"===V?.connector?.connectorType||n.isMobile&&"injected"===V?.connector?.connectorType&&"phantom"===V?.connector?.walletClientType,je="connected"===V?.status,pe="switching_to_supported_chain"===V?.status;r.useEffect((()=>{let e=X(),r=e instanceof o.SiweFlow||e instanceof i.SiwsFlow?e:void 0;je&&!r&&(!ue||de||W?K(V.connectedWallet,de,z?.login?.disableSignup).then((()=>{ae(!0)})):(H({captchaModalData:{callback:e=>K(V.connectedWallet,e,z?.login?.disableSignup).then((()=>{ae(!0)})),userIntentRequired:!1,onSuccessNavigateTo:T.ModalScreen.AWAITING_CONNECTION,onErrorNavigateTo:T.ModalScreen.ERROR_SCREEN}}),P(T.ModalScreen.CAPTCHA_SCREEN,!1))),r&&he&&je&&!r.preparedMessage?r.buildMessage():r&&!he&&je&&(I||(async()=>{k(!0),M(void 0);try{"wallet_connect_v2"===V?.connector?.connectorType&&"metamask"===V?.connector?.walletClientType&&await b.sleep(2500),await Ce()}catch(e){console.warn("Auto-prompted signature failed",e)}finally{k(!1)}})())}),[Z,je,ce]),r.useEffect((()=>{if(re&&l){let e=C.DEFAULT_SUCCESS_SCREEN_DURATION_MS-500;if(U?.legal.requireUsersAcceptTerms&&!re.hasAcceptedTerms){let r=setTimeout((()=>{P(T.ModalScreen.AFFIRMATIVE_CONSENT_SCREEN)}),e);return()=>clearTimeout(r)}if(s.shouldProceedtoEmbeddedWalletCreationFlow(re,U?.embeddedWallets?.createOnLogin)){let r=setTimeout((()=>{H({createWallet:{onSuccess:()=>{},onFailure:e=>{console.error(e),Q({eventName:"embedded_wallet_creation_failure_logout",payload:{error:e,screen:"ConnectionStatusScreen"}}),L()},callAuthOnSuccessOnClose:!0}}),P(T.ModalScreen.EMBEDDED_WALLET_ON_ACCOUNT_CREATE_SCREEN)}),e);return()=>clearTimeout(r)}G();let r=setTimeout((()=>J({shouldCallAuthOnSuccess:!0,isSuccess:!0})),C.DEFAULT_SUCCESS_SCREEN_DURATION_MS);return()=>clearTimeout(r)}}),[re,l]);let Ee=e=>{if(e?.privyErrorCode!==q.PrivyErrorCode.ALLOWLIST_REJECTED){if(e?.privyErrorCode===q.PrivyErrorCode.USER_LIMIT_REACHED)return console.error(new q.PrivyUserLimitReachedError(e).toString()),void P(T.ModalScreen.USER_LIMIT_REACHED_SCREEN);if(e?.privyErrorCode!==q.PrivyErrorCode.USER_DOES_NOT_EXIST)return e?.privyErrorCode===q.PrivyErrorCode.ACCOUNT_TRANSFER_REQUIRED&&e.data?.data?.nonce?(H({accountTransfer:{nonce:e.data?.data?.nonce,account:X()?.meta.address,displayName:e.data?.data?.account?.displayName,externalWalletMetadata:{walletClientType:X()?.meta.walletClientType,chainId:X()?.meta.chainId,connectorType:X()?.meta.connectorType},linkMethod:"siwe",embeddedWalletAddress:e.data?.data?.otherUser?.embeddedWalletAddress}}),void P(T.ModalScreen.LINK_CONFLICT_SCREEN)):void M(R(e));P(T.ModalScreen.ACCOUNT_NOT_FOUND_SCREEN)}else P(T.ModalScreen.ALLOWLIST_REJECTION_SCREEN)};async function Ce(){try{await $(),A(!0)}catch(e){Ee(e)}finally{k(!1)}}r.useEffect((()=>{V?.connectError&&Ee(V?.connectError)}),[V]),y.default((()=>{let e="wallet_connect_v2"===qe&&V?.connector instanceof E.WalletConnectV2WalletConnector?V.connector.redirectUri:void 0;e&&oe(e);let r="wallet_connect_v2"===qe&&V?.connector instanceof E.WalletConnectV2WalletConnector?V.connector.fallbackUniversalRedirectUri:void 0;r&&se(r)}),V?.connector instanceof E.WalletConnectV2WalletConnector&&!te?500:null);let qe=V?.connector?.connectorType||"injected",ye=V?.connector?.walletClientType||"unknown",ge=_.WALLET_UI_MAP[ye]?.displayName||V?.connector?.walletBranding.name||"Browser Extension",we=_.WALLET_UI_MAP[ye]?.logo||V?.connector?.walletBranding.icon||(r=>/*#__PURE__*/e.jsx(f.BrowserExtensionWallet,{...r})),Se="Browser Extension"===ge?ge.toLowerCase():ge;t=l?`Successfully connected with ${Se}`:O?O.message:pe?"Switching networks":je?I&&he?"Signing":"Sign to verify":`Waiting for ${Se}`;let ve="Don’t see your wallet? Check your other browser windows.";l?ve=ne===(re?.linkedAccounts.length||0)?"Wallet was already linked.":"You’re good to go!":Z>=2&&O?ve="Unable to connect wallet":O?ve=O.detail:pe?ve="Switch your wallet to the requested network.":je&&he?ve="Sign the message in your wallet to verify it belongs to you.":"metamask"===ye&&n.isMobile?ve="Click continue to open and connect MetaMask.":"metamask"===ye?ve="For the best experience, connect only one wallet at a time.":"wallet_connect"===qe?ve="Open your mobile wallet app to continue":"coinbase_wallet"!==qe||j.isCoinbaseWalletInstalled()||(ve=p.userAlreadyHasConnectedCoinbaseWallet(re)?"Continue with the Coinbase app. Not the right wallet? Reset your connection below.":"Open the Coinbase app on your phone to continue.");let _e=Y?.walletConnectors?.find((e=>"coinbase_wallet"===e.walletClientType)),me="coinbase_wallet"===ye&&(p.userAlreadyHasConnectedCoinbaseWallet(re)||O===h.ConnectorErrors.ERROR_USER_EXISTS);/*#__PURE__*/return e.jsxs(e.Fragment,{children:[/*#__PURE__*/e.jsx(d.ModalHeader,{backFn:F&&B!==F?D:void 0}),/*#__PURE__*/e.jsxs(x,{children:[/*#__PURE__*/e.jsx(N,{walletLogo:we,success:l,fail:!!O}),/*#__PURE__*/e.jsxs(a.FixedGappedContainer,{children:[/*#__PURE__*/e.jsx("h3",{children:t}),/*#__PURE__*/e.jsx("p",{children:ve}),je||!te||le?null:/*#__PURE__*/e.jsxs("p",{children:["Still here?"," ",/*#__PURE__*/e.jsx("a",{href:te,target:"_blank",style:{textDecoration:"underline"},children:"Try connecting again"}),ie&&/*#__PURE__*/e.jsxs(e.Fragment,{children:[" ","or"," ",/*#__PURE__*/e.jsx("a",{href:ie,target:"_blank",style:{textDecoration:"underline"},children:"use this different link"})]})]})]}),me?/*#__PURE__*/e.jsx(c.PrimaryButton,{onClick:()=>_e&&_e?.disconnect(),disabled:l,children:"Use a different wallet"}):O==h.ConnectorErrors.ERROR_USER_EXISTS&&B!==F?/*#__PURE__*/e.jsx(c.PrimaryButton,{onClick:D,children:"Use a different wallet"}):je&&!l&&he?/*#__PURE__*/e.jsx(c.PrimaryButton,{onClick:()=>{k(!0),Ce()},disabled:I,children:I?"Signing":"Sign with your wallet"}):!l&&O?.retryable&&Z<2?/*#__PURE__*/e.jsx(c.PrimaryButton,{onClick:()=>{ee(Z+1),M(void 0),je?(k(!0),Ce()):V?.connectRetry()},disabled:!l&&(!O?.retryable||Z>=2),children:"Retry"}):l||O?null:/*#__PURE__*/e.jsx(c.PrimaryButton,{onClick:()=>{},disabled:!0,children:"Connecting"})]}),/*#__PURE__*/e.jsx(u.ModalFooter,{})]})},exports.WalletLoading=N,exports.getErrorDetails=R;
