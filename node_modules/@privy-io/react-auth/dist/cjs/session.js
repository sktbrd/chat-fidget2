"use strict";var e=require("js-cookie"),t=require("./auth-flows/authFlowToAuthenticateMethod.js"),s=require("./client/user.js"),r=require("./constants.js"),o=require("./cookies.js"),n=require("./effect.js"),i=require("./errors.js"),c=require("./paths.js"),a=require("./storage.js"),h=require("./token.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("./auth-flows/custom-jwt-account.js"),require("./auth-flows/email.js"),require("./auth-flows/getUiHeader.js"),require("./auth-flows/guest.js"),require("jose"),require("./crypto.js"),require("./auth-flows/siwe.js"),require("./lib/siwe.js"),require("ofetch"),require("./auth-flows/sms.js"),require("./auth-flows/oauth/OAuthFlow.js"),require("./lib/pkce.js"),require("@ethersproject/address"),require("react-device-detect");var l,_=/*#__PURE__*/u(e),k=((l={}).PRIVY="privy_access_token",l.CUSTOMER="customer_access_token",l);exports.AccessTokenTypes=k,exports.Session=class{get token(){return this.privyAccessToken||this.customerAccessToken}getToken(e){return"privy_access_token"===e?this.privyAccessToken:this.customerAccessToken}get customerAccessToken(){return this._getToken(r.CUSTOMER_ACCESS_TOKEN_STORAGE_KEY)}get privyAccessToken(){return this._getToken(r.PRIVY_ACCESS_TOKEN_STORAGE_KEY)}_getToken(e){try{let t=a.default.get(e);return"string"==typeof t?h.Token.throwIfNotWellFormedJwt(t):null}catch(e){return console.error(e),this.destroyLocalState(),null}}get refreshToken(){try{let e=a.default.get(r.REFRESH_TOKEN_STORAGE_KEY);return"string"==typeof e?e:null}catch(e){return console.error(e),this.destroyLocalState(),null}}get forkedToken(){try{let e=a.default.get(r.FORKED_TOKEN_STORAGE_KEY);return"string"==typeof e?e:null}catch(e){return console.error(e),this.destroyLocalState(),null}}getProviderAccessToken(e){try{let t=a.default.get(r.getProviderAccessTokenStorageKey(e));if("string"!=typeof t)return null;{let s=new h.Token(t);return s.isExpired()?(a.default.del(r.getProviderAccessTokenStorageKey(e)),null):s.value}}catch(e){return console.error(e),null}}get mightHaveServerCookies(){try{let e=_.default.get(r.SESSION_COOKIE_KEY);return void 0!==e&&e.length>0}catch(e){console.error(e)}return!1}hasRefreshCredentials(e="privy_access_token"){let t="string"==typeof this.getToken(e),s="string"==typeof this.refreshToken&&this.refreshToken!==r.DEPRECATED_REFRESH_TOKEN;return this.mightHaveServerCookies||t&&s}hasRecoveryCredentials(){return"string"==typeof this.forkedToken}hasActiveAccessToken(e){let t=h.Token.parse(this.getToken(e));return null!==t&&!t.isExpired(30)}authenticate(e){return this.authenticateOnce.execute(e)}link(e){return this.linkOnce.execute(e)}refresh(){return this.refreshOnce.execute()}forkSession(){return this.forkSessionOnce.execute()}destroy(){return this.destroyOnce.execute()}storeProviderAccessToken(e,t){"string"==typeof t?a.default.put(r.getProviderAccessTokenStorageKey(e),t):a.default.del(r.getProviderAccessTokenStorageKey(e))}async _authenticate(e){try{let t=await e.authenticate(),{user:r,is_new_user:o,oauth_tokens:n}=t;this.handleTokenResponse(t);let i=n?{provider:n.provider,accessToken:n.access_token,accessTokenExpiresInSeconds:n.access_token_expires_in_seconds,refreshToken:n.refresh_token,refreshTokenExpiresInSeconds:n.refresh_token_expires_in_seconds,scopes:n.scopes}:void 0;return this._trackAuthenticateEvents(e,o),{user:s.convertUserResponseToUser(r),isNewUser:o,oAuthTokens:i}}catch(e){throw console.warn("Error authenticating session"),i.formatPrivyError(e)}}_trackAuthenticateEvents(e,s){let r=t.authFlowToAuthenticateMethod(e);r&&this.client&&this.client.createAnalyticsEvent({eventName:"sdk_authenticate",payload:{method:r,isNewUser:s}}),"siwe"===r&&this.client&&this.client.createAnalyticsEvent({eventName:"sdk_authenticate_siwe",payload:{connectorType:e.meta.connectorType,walletClientType:e.meta.walletClientType}})}async _link(e){try{let t=await e.link(),r=t.oauth_tokens,o=r?{provider:r.provider,accessToken:r.access_token,accessTokenExpiresInSeconds:r.access_token_expires_in_seconds,refreshToken:r.refresh_token,refreshTokenExpiresInSeconds:r.refresh_token_expires_in_seconds,scopes:r.scopes}:void 0;return{user:s.convertUserResponseToUser(t),oAuthTokens:o}}catch(e){throw console.warn("Error linking account"),i.formatPrivyError(e)}}async _refresh(){if(!this.api)throw new i.PrivyClientError("Session has no API instance");if(!this.client)throw new i.PrivyClientError("Session has no PrivyClient instance");await this.client.getAccessToken({disableAutoRefresh:!0});let e=this.token,t=this.refreshToken,r=this.forkedToken;if(this.client.useServerCookies&&!this.mightHaveServerCookies&&this.token&&window.location.origin===this.client.apiUrl)return this.destroyLocalState(),null;try{let o;if(e&&t||this.mightHaveServerCookies){let s={};e&&(s.authorization=`Bearer ${e}`),o=await this.api.post(c.sessionsRefreshPath,t?{refresh_token:t}:{},{headers:s}),r&&this.clearForkedToken()}else{if(!r)return null;o=await this.api.post(c.recoverForkedSessionsPath,{refresh_token:r}),this.clearForkedToken()}return this.handleTokenResponse(o),s.convertUserResponseToUser(o.user)}catch(e){if(e instanceof i.PrivyApiError&&e.privyErrorCode===i.PrivyErrorCode.MISSING_OR_INVALID_TOKEN)return console.warn("Unable to refresh tokens - token is missing or no longer valid"),this.destroyLocalState(),null;throw i.formatPrivyError(e)}}handleTokenResponse(e){e.session_update_action&&"set"!==e.session_update_action?"clear"===e.session_update_action?this.destroyLocalState():"ignore"===e.session_update_action&&(e.token&&(this.storeCustomerAccessToken(e.token),this.storePrivyAccessToken(e.privy_access_token)),e.identity_token&&this.storeIdentityToken(e.identity_token)):this._storeAllTokens(e)}_storeAllTokens(e){this.storeRefreshToken(e.refresh_token),this.storeCustomerAccessToken(e.token),this.storePrivyAccessToken(e.privy_access_token),e.identity_token&&this.storeIdentityToken(e.identity_token)}async _destroy(){try{await(this.api?.post(c.sessionsLogoutPath,{refresh_token:this.refreshToken}))}catch(e){console.warn("Error destroying session")}this.destroyLocalState()}async _forkSession(){if(!this.api)throw new i.PrivyClientError("Session has no API instance");let e=this.refreshToken;try{let t=await this.api.post(c.forkSessionPath,{refresh_token:e});return this.storeRefreshToken(t.refresh_token),this.storeCustomerAccessToken(t.token),t.new_session_refresh_token}catch(e){throw i.formatPrivyError(e)}}destroyLocalState(){this.storeRefreshToken(null),this.storeCustomerAccessToken(null),this.storePrivyAccessToken(null),this.clearIdentityToken(),this.clearForkedToken()}storeCustomerAccessToken(e){if("string"==typeof e){let t=a.default.get(r.CUSTOMER_ACCESS_TOKEN_STORAGE_KEY);if(a.default.put(r.CUSTOMER_ACCESS_TOKEN_STORAGE_KEY,e),!this.client?.useServerCookies){let t=h.Token.parse(e)?.expiration;_.default.set(r.CUSTOMER_ACCESS_TOKEN_COOKIE_KEY,e,{sameSite:"Strict",secure:o.getSecureMode(),expires:t?new Date(1e3*t):void 0})}t!==e&&this.client?.onStoreCustomerAccessToken?.(e)}else a.default.del(r.CUSTOMER_ACCESS_TOKEN_STORAGE_KEY),_.default.remove(r.CUSTOMER_ACCESS_TOKEN_COOKIE_KEY),this.client?.onDeleteCustomerAccessToken?.()}storeRefreshToken(e){"string"==typeof e?(a.default.put(r.REFRESH_TOKEN_STORAGE_KEY,e),this.client?.useServerCookies||_.default.set(r.SESSION_COOKIE_KEY,"t",{sameSite:"Strict",secure:o.getSecureMode(),expires:30})):(a.default.del(r.REFRESH_TOKEN_STORAGE_KEY),_.default.remove(r.REFRESH_TOKEN_COOKIE_KEY),_.default.remove(r.SESSION_COOKIE_KEY))}storePrivyAccessToken(e){"string"==typeof e?a.default.put(r.PRIVY_ACCESS_TOKEN_STORAGE_KEY,e):a.default.del(r.PRIVY_ACCESS_TOKEN_STORAGE_KEY)}storeIdentityToken(e){if(this.client?.useServerCookies)return;a.default.put(r.IDENTITY_TOKEN_STORAGE_KEY,e);let t=h.Token.parse(e)?.expiration;_.default.set(r.IDENTITY_TOKEN_COOKIE_KEY,e,{sameSite:"Strict",secure:o.getSecureMode(),expires:t?new Date(1e3*t):void 0})}clearIdentityToken(){a.default.del(r.IDENTITY_TOKEN_STORAGE_KEY),_.default.remove(r.IDENTITY_TOKEN_COOKIE_KEY)}clearForkedToken(){a.default.del(r.FORKED_TOKEN_STORAGE_KEY)}constructor(){this.authenticateOnce=new n.RunEffectOnce((async e=>this._authenticate(e))),this.linkOnce=new n.RunEffectOnce((async e=>this._link(e))),this.refreshOnce=new n.RunEffectOnce(this._refresh.bind(this)),this.destroyOnce=new n.RunEffectOnce(this._destroy.bind(this)),this.forkSessionOnce=new n.RunEffectOnce(this._forkSession.bind(this))}};
