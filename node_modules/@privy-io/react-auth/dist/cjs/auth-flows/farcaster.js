"use strict";var e=require("react-device-detect"),t=require("../connectors/walletconnect-registry.js"),i=require("../effect.js"),n=require("../errors.js"),r=require("../paths.js");require("../storage.js"),require("../utils/index.js"),require("@ethersproject/providers"),require("../connectors/get-legacy-injected-providers.js"),require("../connectors/is-wallet-installed.js"),require("ofetch");exports.FarcasterFlow=class{get meta(){return this._meta}async authenticate(){if(!this.api)throw new n.PrivyClientError("Auth flow has no API instance");if(!this.meta.channelToken)throw new n.PrivyClientError("Auth flow must be initialized first");try{let e=await this.api.post(r.farcasterAuthenticatePath,{channel_token:this.meta.channelToken,message:this.message,signature:this.signature,fid:this.fid,mode:this.meta.disableSignup?"no-signup":"login-or-sign-up"});if(!e)throw new n.PrivyClientError("No response from authentication");return e}catch(e){throw n.formatApiError(e)}}async link(){if(!this.api)throw new n.PrivyClientError("Auth flow has no API instance");try{return await this.api.post(r.farcasterLinkPath,{channel_token:this.meta.channelToken,message:this.message,signature:this.signature,fid:this.fid})}catch(e){throw n.formatApiError(e)}}async _startChannelOnce(){if(!this.api)throw new n.PrivyClientError("Auth flow has no API instance");let i=await this.api.post(r.farcasterInitPath,{token:this.captchaToken});e.isMobile&&!e.isIOS&&i.connect_uri&&t.openHref(i.connect_uri,"_blank"),this._meta={...this._meta,connectUri:i.connect_uri,channelToken:i.channel_token}}async initializeFarcasterConnect(){if(!this.api)throw new n.PrivyClientError("Auth flow has no API instance");await this.startChannelOnce.execute()}async _pollForReady(){if(!this.api)throw new n.PrivyClientError("Auth flow has no API instance");if(!this.meta.channelToken)throw new n.PrivyClientError("Auth flow must be initialized first");let e=await this.api.get(r.farcasterStatusPath,{headers:{"farcaster-channel-token":this.meta.channelToken}});return"completed"===e.state&&(this.message=e.message,this.signature=e.signature,this.fid=e.fid,!0)}constructor(e,t=!1){this._meta={disableSignup:!1},this.captchaToken=e,this.startChannelOnce=new i.RunEffectOnce(this._startChannelOnce.bind(this)),this.pollForReady=new i.RunEffectOnce(this._pollForReady.bind(this)),this._meta.disableSignup=t}};
