"use strict";var t=require("../effect.js"),e=require("../errors.js"),i=require("../paths.js"),n=require("./getUiHeader.js");require("ofetch");exports.PasskeyFlow=class{async initAuthenticationFlow(t){if(!this.api)throw new e.PrivyClientError("Auth flow has no API instance");this.meta.initAuthenticateResponse=await this.initAuthenticateOnce.execute(t)}async initLinkFlow(){if(!this.api)throw new e.PrivyClientError("Auth flow has no API instance");this.meta.initLinkResponse=await this.initLinkOnce.execute()}async authenticate(){let t=await import("@simplewebauthn/browser");if(!this.api)throw new e.PrivyClientError("Auth flow has no API instance");if(!t.browserSupportsWebAuthn())throw new e.PrivyClientError("WebAuthn is not supported in this browser");this.meta.initAuthenticateResponse||(this.meta.initAuthenticateResponse=await this.initAuthenticateOnce.execute());try{let e=await t.startAuthentication(this._transformInitAuthenticateOptionsToCamelCase(this.meta.initAuthenticateResponse.options));return this.meta.setPasskeyAuthState?.({status:"submitting-response"}),await this.api.post(i.passkeyAuthenticatePath,{relying_party:this.meta.initAuthenticateResponse.relying_party,challenge:this.meta.initAuthenticateResponse.options.challenge,authenticator_response:this._transformAuthenticationResponseToSnakeCase(e)})}catch(t){if("NotAllowedError"===t.name)throw new e.PrivyClientError("Passkey request timed out or rejected by user.",void 0,e.PrivyErrorCode.PASSKEY_NOT_ALLOWED);throw e.formatApiError(t)}}async link(){let t=await import("@simplewebauthn/browser");if(!this.api)throw new e.PrivyClientError("Auth flow has no API instance");if(!t.browserSupportsWebAuthn())throw new e.PrivyClientError("WebAuthn is not supported in this browser");this.meta.initLinkResponse||(this.meta.initLinkResponse=await this.initLinkOnce.execute());try{let e=this.meta.initLinkResponse.options,n=await t.startRegistration(this._transformInitLinkOptionsToCamelCase(e));return this.meta.setPasskeyAuthState?.({status:"submitting-response"}),await this.api.post(i.passkeyLinkPath,{relying_party:this.meta.initLinkResponse.relying_party,authenticator_response:this._transformRegistrationResponseToSnakeCase(n)})}catch(t){if("NotAllowedError"===t.name)throw new e.PrivyClientError("Passkey request timed out or rejected by user.",void 0,e.PrivyErrorCode.PASSKEY_NOT_ALLOWED);throw e.formatApiError(t)}}async _initAuthenticateOnce(t){if(!this.api)throw new e.PrivyClientError("Auth flow has no API instance");let s=n.getUiHeader(t);return await this.api.post(i.passkeyInitAuthenticatePath,{token:this.meta.captchaToken},{headers:{...s}})}async _initLinkOnce(){if(!this.api)throw new e.PrivyClientError("Auth flow has no API instance");return await this.api.post(i.passkeyInitLinkPath,{})}_transformInitLinkOptionsToCamelCase(t){return{rp:t.rp,user:{id:t.user.id,name:t.user.name,displayName:t.user.display_name},challenge:t.challenge,pubKeyCredParams:t.pub_key_cred_params.map((t=>({type:t.type,alg:t.alg}))),timeout:t.timeout,excludeCredentials:t.exclude_credentials?.map((t=>({id:t.id,type:t.type,transports:t.transports}))),authenticatorSelection:{authenticatorAttachment:t.authenticator_selection?.authenticator_attachment,requireResidentKey:t.authenticator_selection?.require_resident_key,residentKey:t.authenticator_selection?.resident_key,userVerification:t.authenticator_selection?.user_verification},attestation:t.attestation,extensions:{appid:t.extensions?.app_id,credProps:t.extensions?.cred_props?.rk,hmacCreateSecret:t.extensions?.hmac_create_secret}}}_transformRegistrationResponseToSnakeCase(t){return{id:t.id,raw_id:t.rawId,response:{client_data_json:t.response.clientDataJSON,attestation_object:t.response.attestationObject,authenticator_data:t.response.authenticatorData},authenticator_attachment:t.authenticatorAttachment,client_extension_results:{app_id:t.clientExtensionResults.appid,cred_props:t.clientExtensionResults.credProps,hmac_create_secret:t.clientExtensionResults.hmacCreateSecret},type:t.type}}_transformInitAuthenticateOptionsToCamelCase(t){return{rpId:t.rp_id,challenge:t.challenge,allowCredentials:t.allow_credentials?.map((t=>({id:t.id,type:t.type,transports:t.transports})))||[],timeout:t.timeout,extensions:{appid:t.extensions?.app_id,credProps:t.extensions?.cred_props,hmacCreateSecret:t.extensions?.hmac_create_secret},userVerification:t.user_verification}}_transformAuthenticationResponseToSnakeCase(t){return{id:t.id,raw_id:t.rawId,response:{client_data_json:t.response.clientDataJSON,authenticator_data:t.response.authenticatorData,signature:t.response.signature,user_handle:t.response.userHandle},authenticator_attachment:t.authenticatorAttachment,client_extension_results:{app_id:t.clientExtensionResults.appid,cred_props:t.clientExtensionResults.credProps,hmac_create_secret:t.clientExtensionResults.hmacCreateSecret},type:t.type}}constructor({captchaToken:e,setPasskeyAuthState:i}){this.initAuthenticateOnce=new t.RunEffectOnce(this._initAuthenticateOnce.bind(this)),this.initLinkOnce=new t.RunEffectOnce(this._initLinkOnce.bind(this)),this.meta={captchaToken:e,setPasskeyAuthState:i}}};
