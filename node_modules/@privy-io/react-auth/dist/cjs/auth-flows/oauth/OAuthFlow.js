"use strict";var t=require("../../constants.js"),e=require("../../errors.js"),i=require("../../lib/pkce.js"),r=require("../../paths.js"),o=require("../../storage.js"),a=require("../getUiHeader.js");require("ofetch"),require("jose"),require("../../crypto.js");exports.OAuthFlow=class{addCaptchaToken(t){this.meta.captchaToken=t}isActive(){return!!(this.meta.authorizationCode&&this.meta.stateCode&&this.meta.provider)}async authenticate(){if(!this.api)throw new e.PrivyClientError("Auth flow has no API instance");if(!this.meta.authorizationCode||!this.meta.stateCode)throw new e.PrivyClientError("[OAuth AuthFlow] Authorization and state codes code must be set prior to calling authenticate.");if("undefined"===this.meta.authorizationCode)throw new e.PrivyClientError("User denied confirmation during OAuth flow");let a=i.getCodeVerifier();try{let e=await this.api.post(r.oAuthAuthenticatePath,{authorization_code:this.meta.authorizationCode,state_code:this.meta.stateCode,code_verifier:a,mode:this.meta.disableSignup?"no-signup":"login-or-sign-up"});return o.default.del(t.CODE_VERIFIER_KEY),o.default.del(t.HEADLESS_OAUTH_KEY),o.default.del(t.OAUTH_DISABLE_SIGNUP_KEY),e}catch(t){let i=e.formatApiError(t);if(i.privyErrorCode)throw new e.PrivyClientError(i.message||"Invalid code during OAuth flow.",void 0,i.privyErrorCode);if("User denied confirmation during OAuth flow"===i.message)throw new e.PrivyClientError("Invalid code during oauth flow.",void 0,e.PrivyErrorCode.OAUTH_USER_DENIED);throw new e.PrivyClientError("Invalid code during OAuth flow.",void 0,e.PrivyErrorCode.UNKNOWN_AUTH_ERROR)}}async link(){if(!this.api)throw new e.PrivyClientError("Auth flow has no API instance");if(!this.meta.authorizationCode||!this.meta.stateCode)throw new e.PrivyClientError("[OAuth AuthFlow] Authorization and state codes code must be set prior to calling link.");if("undefined"===this.meta.authorizationCode)throw new e.PrivyClientError("User denied confirmation during OAuth flow");let i=o.default.get(t.CODE_VERIFIER_KEY);if(!i)throw new e.PrivyClientError("Authentication error.");try{let e=await this.api.post(r.oAuthLinkPath,{authorization_code:this.meta.authorizationCode,state_code:this.meta.stateCode,code_verifier:i});return o.default.del(t.CODE_VERIFIER_KEY),e}catch(t){throw e.formatApiError(t)}}async getAuthorizationUrl(){if(!this.api)throw new e.PrivyClientError("Auth flow has no API instance");if(!this.meta.provider)throw new e.PrivyClientError("Provider must be set when initializing OAuth authentication.");let n=i.createCodeVerifier();o.default.put(t.CODE_VERIFIER_KEY,n);let h=i.createStateCode();o.default.put(t.STATE_CODE_KEY,h);let s=await i.deriveCodeChallengeFromCodeVerifier(n);this.meta.withPrivyUi||o.default.put(t.HEADLESS_OAUTH_KEY,!0),this.meta.disableSignup&&o.default.put(t.OAUTH_DISABLE_SIGNUP_KEY,!0);let d=a.getUiHeader(this.meta.withPrivyUi);try{return await this.api.post(r.oAuthInitPath,{provider:this.meta.provider,redirect_to:window.location.href,token:this.meta.captchaToken,code_challenge:s,state_code:h},{headers:{...d}})}catch(t){throw e.formatApiError(t)}}constructor(t){this.meta=t}};
