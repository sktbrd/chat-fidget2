"use strict";var e=require("viem"),r=require("../../errors.js"),t=require("../popup/triggerPopup.js"),a=require("./authFlow.js");require("ofetch"),require("../../auth-flows/cross-app.js"),require("../../paths.js"),require("../pkce.js"),require("jose"),require("../../constants.js"),require("../../crypto.js"),require("../../storage.js");let s=r=>JSON.stringify({content:{request:{request:o(r,e.toHex)}},timestamp:Date.now(),callbackUrl:window.origin});const o=(e,r)=>"bigint"==typeof e?r(e):Array.isArray(e)?e.map((e=>o(e,r))):e&&"object"==typeof e?Object.fromEntries(Object.entries(e).map((([e,t])=>[e,o(t,r)]))):e;exports.replaceBigInts=o,exports.sendCrossAppRequest=async({user:e,address:o,client:i,request:n,requesterAppId:d,reconnect:p})=>{i.createAnalyticsEvent({eventName:"cross_app_request_started",payload:{address:o,method:n.method}});let c=e?.linkedAccounts.find((e=>"cross_app"===e.type&&(e.embeddedWallets.some((e=>e.address===o))||e.smartWallets.some((e=>e.address===o)))));if(!e||!c)throw i.createAnalyticsEvent({eventName:"cross_app_request_error",payload:{error:"Cannot request a signature with this wallet address",address:o}}),new r.PrivyClientError("Cannot request a signature with this wallet address");let l=i.getProviderAccessToken(c.providerApp.id),u=await a.getProviderAppMetadata({api:i.api,requesterAppId:d,providerAppId:c.providerApp.id});if(!l){if(u.readOnly)throw console.error("cannot transact against a read-only provider app"),new r.PrivyClientError("Cannot transact against a read-only provider app");await p({appId:c.providerApp.id,action:"link"})&&(l=i.getProviderAccessToken(c.providerApp.id))}if(!l)throw i.createAnalyticsEvent({eventName:"cross_app_request_error",payload:{error:"Transactions require a valid token",address:o}}),new r.PrivyClientError("Transactions require a valid token");let v=t.triggerPopup();if(!v)throw i.createAnalyticsEvent({eventName:"cross_app_request_error",payload:{error:"Missing token",address:o}}),new r.PrivyClientError("Failed to initialize signature request");let q=new URL(`${u.apiUrl}/oauth/transact`);return q.searchParams.set("token",l||""),q.searchParams.set("request",s(n)),v.location=q.href,new Promise(((e,t)=>{let a=setTimeout((()=>{p(),t(new r.PrivyClientError("Request timeout")),i.createAnalyticsEvent({eventName:"cross_app_request_error",payload:{error:"Request timeout",address:o}})}),12e4),s=setInterval((()=>{v.closed&&(p(),t(new r.PrivyClientError("User rejected request")),i.createAnalyticsEvent({eventName:"cross_app_request_error",payload:{error:"User rejected request",address:o}}))}),300),d=r=>{r.data&&("set"===r.data.token?.action&&void 0!==r.data.token?.value?i.storeProviderAccessToken(c.providerApp.id,r.data.token.value):"clear"===r.data.token?.action&&i.storeProviderAccessToken(c.providerApp.id,null),"PRIVY_CROSS_APP_ACTION_RESPONSE"===r.data.type&&r.data.result&&(p(),e(r.data.result),i.createAnalyticsEvent({eventName:"cross_app_request_success",payload:{address:o,method:n.method}})),"PRIVY_CROSS_APP_ACTION_ERROR"===r.data.type&&r.data.error&&(p(),t(r.data.error),i.createAnalyticsEvent({eventName:"cross_app_request_error",payload:{error:r.data.error,address:o}})))};window.addEventListener("message",d);let p=()=>{v.close(),clearInterval(s),clearTimeout(a),window.removeEventListener("message",d)}}))};
